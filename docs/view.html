<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arca View</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, get, set, update, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.firebasestorage.app",
      messagingSenderId: "277809008742",
      appId: "1:277809008742:web:2586a2b821d8da8f969da7",
      measurementId: "G-X7ZQ6DJYEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    const params = new URLSearchParams(window.location.search);
    const arcaId = params.get("id");

    async function loadArca() {
      if (!arcaId) {
        document.getElementById("arcaDetails").innerHTML = `
          <p class="text-center text-slate-400">No Arca ID provided.</p>`;
        return;
      }
      const snapshot = await get(ref(db, `arcas/${arcaId}`));
      if (!snapshot.exists()) {
        document.getElementById("arcaDetails").innerHTML = `
          <p class="text-center text-slate-400">No Arca found with ID ${arcaId}</p>`;
        return;
      }
      const arca = snapshot.val();
      document.getElementById("arcaName").textContent = arca.name;
      document.getElementById("arcaNote").textContent = arca.note;
      loadItems();
    }

    async function loadItems() {
      const itemsRef = ref(db, `arcas/${arcaId}/items`);
      const snapshot = await get(itemsRef);
      const container = document.getElementById("itemsGrid");
      container.innerHTML = "";
      if (snapshot.exists()) {
        const items = snapshot.val();
        Object.entries(items).forEach(([id, item]) => {
          const tile = document.createElement("div");
          tile.className = "bg-slate-800 rounded-xl shadow-lg p-4 flex flex-col items-center space-y-2 cursor-pointer select-none";
          tile.innerHTML = `
            <img src="${item.imageUrl || 'https://via.placeholder.com/150'}" class="w-full h-32 object-cover rounded-md" />
            <h3 class="font-semibold text-lg">${item.name}</h3>
            <p class="text-sm text-slate-400">${item.note || ''}</p>`;
          // Gesture: long-press to edit
          let pressTimer;
          tile.addEventListener("touchstart", () => {
            pressTimer = setTimeout(() => openEditModal(id, item), 600);
          });
          tile.addEventListener("touchend", () => clearTimeout(pressTimer));
          tile.addEventListener("mousedown", () => {
            pressTimer = setTimeout(() => openEditModal(id, item), 600);
          });
          tile.addEventListener("mouseup", () => clearTimeout(pressTimer));
          container.appendChild(tile);
        });
      } else {
        container.innerHTML = `<p class="text-slate-400 col-span-2">No items yet.</p>`;
      }
    }

    function openEditModal(id, item) {
      document.getElementById("modalTitle").textContent = `Edit ${item.name}`;
      document.getElementById("itemName").value = item.name;
      document.getElementById("itemNote").value = item.note || "";
      document.getElementById("saveItem").onclick = () => saveItem(id);
      document.getElementById("itemModal").classList.remove("hidden");
    }

    async function saveItem(id) {
      const name = document.getElementById("itemName").value.trim();
      const note = document.getElementById("itemNote").value.trim();
      await update(ref(db, `arcas/${arcaId}/items/${id}`), { name, note });
      document.getElementById("itemModal").classList.add("hidden");
      loadItems();
    }

    window.onload = loadArca;
  </script>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 id="arcaName" class="text-2xl font-bold"></h1>
      <a href="index.html" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg">Dashboard</a>
    </header>
    <p id="arcaNote" class="text-slate-400"></p>

    <section>
      <h2 class="text-xl font-semibold mb-4">Items</h2>
      <div id="itemsGrid" class="grid grid-cols-2 gap-4"></div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="itemModal" class="fixed inset-0 bg-black/70 flex items-center justify-center hidden">
    <div class="bg-slate-800 p-6 rounded-xl w-80 space-y-4">
      <h3 id="modalTitle" class="text-lg font-semibold"></h3>
      <input id="itemName" type="text" class="w-full p-2 rounded-lg bg-slate-900 text-slate-100" />
      <textarea id="itemNote" rows="3" class="w-full p-2 rounded-lg bg-slate-900 text-slate-100"></textarea>
      <button id="saveItem" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-medium text-lg">Save</button>
      <button onclick="document.getElementById('itemModal').classList.add('hidden')" class="w-full py-2 bg-slate-700 hover:bg-slate-600 rounded-lg mt-2">Cancel</button>
    </div>
  </div>
</body>
</html>
