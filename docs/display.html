<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arca Tethr • Inventory</title>
  <!-- Tailwind (CDN is fine for testing; warning is harmless) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12)}
    .tile{min-width:240px}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Arca Tethr</h1>
        <div id="crumbs" class="text-xs text-slate-400"></div>
      </div>
      <a href="./index.html" class="text-sm text-slate-300 underline underline-offset-4">Switch</a>
    </header>

    <!-- Arca header -->
    <section class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 id="arcaName" class="font-semibold text-slate-100">Loading...</h2>
          <div id="arcaMeta" class="text-xs text-slate-400"></div>
        </div>
        <div class="flex gap-2">
          <button id="addItemBtn" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">
            Add Item
          </button>
        </div>
      </div>
    </section>

    <!-- Items (horizontal tiles) -->
    <section>
      <div id="tiles" class="flex gap-3 overflow-x-auto pb-3"></div>
    </section>
  </main>

  <!-- Photo / Note Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-2">Add Photo / Note</h3>
      <div class="space-y-3">
        <input id="fileInput" type="file" accept="image/*" capture="environment"
               class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2" />
        <textarea id="noteInput" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                  placeholder="Note (optional)"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="modalOk" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- New Item Modal -->
  <div id="newItemModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-3">Add Item</h3>

      <label class="text-xs block mb-1">Name</label>
      <input id="newItemName" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none mb-3" placeholder="e.g., Pasta" />

      <div class="grid grid-cols-3 gap-2 items-end mb-3">
        <div class="col-span-2">
          <label class="text-xs block mb-1">Starting Quantity</label>
          <input id="newItemQty" type="number" min="0" step="1"
                 class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" value="1" />
        </div>
        <div class="flex gap-2">
          <button data-q="1"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+1</button>
          <button data-q="6"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+6</button>
          <button data-q="12" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+12</button>
        </div>
      </div>

      <label class="text-xs block mb-1">Photo (optional)</label>
      <input id="newItemFile" type="file" accept="image/*" capture="environment"
             class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2 mb-3" />

      <label class="text-xs block mb-1">Note (optional)</label>
      <textarea id="newItemNote" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                placeholder="Any details to remember..."></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button id="newItemCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="newItemSave" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2">
    <div id="toastInner" class="rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg">Saved</div>
  </div>

  <!-- Firebase (compat build, simpler than ES modules) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <!-- Inline logic (plain ES5-style, ASCII only) -->
  <script>
    console.log("display compat v1");

    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    var storage = firebase.storage();

    var STORAGE_ROOT = "arca-dev";
    function $(sel){ return document.querySelector(sel); }

    function showToast(msg, type){
      if (msg == null) msg = "Saved";
      if (type == null) type = "ok";
      var toast = $("#toast");
      var inner = $("#toastInner");
      if (!toast || !inner) return;
      inner.textContent = msg;
      inner.className = "rounded-xl px-3 py-2 text-sm shadow-lg " + (type === "ok" ? "bg-slate-800 text-slate-100" : "bg-red-600 text-white");
      toast.classList.remove("hidden");
      setTimeout(function(){ toast.classList.add("hidden"); }, 1200);
    }
    function flashSaved(itemId){
      var tilesEl = $("#tiles");
      if (!tilesEl) return;
      var tile = tilesEl.querySelector('[data-tile="'+itemId+'"]');
      if (!tile) return;
      tile.classList.add("ring-2","ring-emerald-500");
      setTimeout(function(){ tile.classList.remove("ring-2","ring-emerald-500"); }, 700);
    }

    function downscale(file, maxDim, mime, quality){
      return new Promise(function(resolve){
        if (maxDim == null) maxDim = 1200;
        if (mime == null) mime = "image/jpeg";
        if (quality == null) quality = 0.85;
        var img = new Image();
        img.onload = function(){
          var scale = Math.min(1, maxDim / Math.max(img.width, img.height));
          if (scale === 1){ resolve(file); return; }
          var c = document.createElement("canvas");
          c.width = Math.round(img.width * scale);
          c.height = Math.round(img.height * scale);
          c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);
          c.toBlob(function(blob){
            resolve(new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", {type:mime}));
          }, mime, quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    document.addEventListener("DOMContentLoaded", function(){
      var params = new URLSearchParams(location.search);
      var arcaId = (params.get("arcaId") || "").trim();

      if (!arcaId){
        document.body.innerHTML = '<main class="max-w-md mx-auto p-6 text-sm">Missing <b>arcaId</b>. <a href="./index.html" class="underline underline-offset-4">Go back</a>.</main>';
        return;
      }

      var crumbs = $("#crumbs");
      var arcaName = $("#arcaName");
      var arcaMeta = $("#arcaMeta");
      var tilesEl = $("#tiles");
      var addItemBtn = $("#addItemBtn");

      var modal = $("#modal");
      var modalOk = $("#modalOk");
      var modalCancel = $("#modalCancel");
      var fileInput = $("#fileInput");
      var noteInput = $("#noteInput");

      var newItemModal  = $("#newItemModal");
      var newItemName   = $("#newItemName");
      var newItemQty    = $("#newItemQty");
      var newItemFile   = $("#newItemFile");
      var newItemNote   = $("#newItemNote");
      var newItemSave   = $("#newItemSave");
      var newItemCancel = $("#newItemCancel");

      var items = {};
      var arcaRef  = db.ref("arca/" + arcaId);
      var itemsRef = db.ref("arca/" + arcaId + "/items");

      arcaRef.on("value", function(snap){
        var arca = snap.val() || {};
        arcaName.textContent = arca.name ? arca.name : arcaId;
        var bits = [];
        if (arca.type) bits.push(arca.type);
        if (arca.location) bits.push(arca.location);
        arcaMeta.textContent = bits.join(" • ");
        crumbs.textContent = arca.name ? arca.name : arcaId;
      });

      itemsRef.on("value", function(snap){
        items = snap.val() || {};
        renderItems();
      });

      function renderItems(){
        tilesEl.innerHTML = "";
        var ids = Object.keys(items);
        if (ids.length === 0){
          tilesEl.innerHTML = '<div class="glass p-4 rounded-2xl text-sm text-slate-300">No items yet. Use "Add Item".</div>';
          return;
        }
        ids.forEach(function(id){
          var item = items[id] || {};
          var imgUrl = (item.images && item.images[0] && item.images[0].url) ? item.images[0].url : "";
          var tile = document.createElement("div");
          tile.className = "tile glass rounded-2xl p-3 relative";
          tile.setAttribute("data-tile", id);

          var html = '';
          html += '<div class="w-full aspect-video rounded-xl bg-slate-800 overflow-hidden mb-2">';
          if (imgUrl){
            html += '<img src="'+imgUrl+'" class="w-full h-full object-cover" alt="">';
          } else {
            html += '<div class="w-full h-full flex items-center justify-center text-xs text-slate-500">No Photo</div>';
          }
          html += '</div>';
          html += '<div class="font-semibold">'+(item.name || 'Unnamed')+'</div>';
          html += '<div class="text-xs text-slate-400">Qty: <span class="font-mono">'+(item.qty || 0)+'</span></div>';
          html += '<div class="mt-3 grid grid-cols-3 gap-2">';
          html += '  <button data-act="photo" data-id="'+id+'" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Photo/Note</button>';
          html += '  <button data-act="minus" data-id="'+id+'" class="rounded-xl bg-red-500/80 hover:bg-red-500 text-slate-900 font-semibold px-0 py-2 text-lg">-</button>';
          html += '  <button data-act="plus"  data-id="'+id+'" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-0 py-2 text-lg">+</button>';
          html += '</div>';

          tile.innerHTML = html;
          Array.prototype.forEach.call(tile.querySelectorAll("button"), function(b){
            b.addEventListener("click", onTileAction);
          });
          tilesEl.appendChild(tile);
        });
      }

      function adjustQty(itemId, delta){
        var qtyRef = db.ref("arca/" + arcaId + "/items/" + itemId + "/qty");
        qtyRef.transaction(function(current){
          var base = current || 0;
          var next = base + delta;
          if (next < 0) next = 0;
          return next;
        }, function(err){
          if (err){ console.error(err); showToast("Error updating qty", "error"); }
          else {
            db.ref("arca/" + arcaId + "/items/" + itemId).update({ lastUpdated: Date.now() });
            showToast(delta > 0 ? "+1" : "-1", "ok");
            flashSaved(itemId);
          }
        });
      }

      function onTileAction(e){
        var id = e.currentTarget.getAttribute("data-id");
        var act = e.currentTarget.getAttribute("data-act");
        if (act === "minus") adjustQty(id, -1);
        if (act === "plus")  adjustQty(id, +1);
        if (act === "photo") openPhotoModal(id);
      }

      function openPhotoModal(itemId){
        modal.setAttribute("data-item-id", itemId);
        if (fileInput) fileInput.value = "";
        if (noteInput) noteInput.value = "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      modalCancel.addEventListener("click", function(){
        modal.classList.add("hidden"); modal.classList.remove("flex");
      });
      modalOk.addEventListener("click", function(){
        var itemId = modal.getAttribute("data-item-id");
        var file = (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;
        var note = noteInput ? (noteInput.value || "").trim() : "";
        if (!file && !note){
          modal.classList.add("hidden"); modal.classList.remove("flex"); return;
        }
        savePhotoNote(itemId, file, note).then(function(){
          showToast("Saved","ok"); flashSaved(itemId);
        }).catch(function(e){
          console.error(e); showToast("Error saving","error");
        }).finally(function(){
          modal.classList.add("hidden"); modal.classList.remove("flex");
        });
      });

      function savePhotoNote(itemId, file, note){
        return new Promise(function(resolve, reject){
          var now = Date.now();
          function finish(url){
            var itemRef = db.ref("arca/" + arcaId + "/items/" + itemId);
            itemRef.once("value").then(function(snap){
              var item = snap.val() || {};
              var images = Array.isArray(item.images) ? item.images.slice() : [];
              var updates = { lastUpdated: now };
              if (url){
                images.unshift({ url: url, path: "", takenAt: now });
                updates.images = images.slice(0, 6);
              }
              if (note){
                var prev = item.notes || "";
                updates.notes = prev ? (prev + "\n" + note) : note;
              }
              return itemRef.update(updates);
            }).then(resolve).catch(reject);
          }
          if (!file){ finish(null); return; }
          downscale(file, 1200, "image/jpeg", 0.85).then(function(safe){
            var path = STORAGE_ROOT + "/" + arcaId + "/" + itemId + "/" + now + "-" + safe.name;
            return storage.ref(path).put(safe).then(function(snap){ return snap.ref.getDownloadURL(); });
          }).then(function(url){ finish(url); }).catch(reject);
        });
      }

      function openNewItemModal(){
        newItemName.value = "";
        newItemQty.value = "1";
        newItemFile.value = "";
        newItemNote.value = "";
        newItemModal.classList.remove("hidden");
        newItemModal.classList.add("flex");
        setTimeout(function(){ newItemName.focus(); }, 30);
      }
      function closeNewItemModal(){
        newItemModal.classList.add("hidden");
        newItemModal.classList.remove("flex");
      }
      addItemBtn.addEventListener("click", openNewItemModal);
      newItemCancel.addEventListener("click", closeNewItemModal);

      Array.prototype.forEach.call(newItemModal.querySelectorAll('button[data-q]'), function(btn){
        btn.addEventListener("click", function(ev){
          var add = parseInt(ev.currentTarget.getAttribute("data-q"), 10) || 0;
          var current = parseInt(newItemQty.value || "0", 10) || 0;
          newItemQty.value = String(current + add);
        });
      });

      newItemSave.addEventListener("click", function(){
        var name = (newItemName.value || "").trim();
        var qty  = Math.max(0, parseInt(newItemQty.value || "0", 10) || 0);
        var file = (newItemFile.files && newItemFile.files[0]) ? newItemFile.files[0] : null;
        var note = (newItemNote.value || "").trim();
        if (!name){ showToast("Name is required","error"); return; }

        var now = Date.now();
        var newId = "item-" + now + "-" + Math.floor(Math.random()*100000);
        function writeItem(images){
          db.ref("arca/" + arcaId + "/items/" + newId).set({
            name: name,
            qty: qty,
            images: images || [],
            notes: note || "",
            createdAt: now,
            lastUpdated: now
          }).then(function(){
            closeNewItemModal();
            showToast("Item saved","ok");
            setTimeout(function(){ flashSaved(newId); }, 250);
          }).catch(function(e){
            console.error(e); showToast("Error saving item","error");
          });
        }

        if (!file){ writeItem([]); return; }
        downscale(file, 1200, "image/jpeg", 0.85).then(function(safe){
          var path = STORAGE_ROOT + "/" + arcaId + "/" + newId + "/" + now + "-" + safe.name;
          return storage.ref(path).put(safe).then(function(snap){ return snap.ref.getDownloadURL().then(function(url){ return [{ url: url, path: path, takenAt: now }]; }); });
        }).then(function(images){
          writeItem(images);
        }).catch(function(e){
          console.error(e); showToast("Upload failed","error");
        });
      });
    });
  </script>
</body>
</html>
