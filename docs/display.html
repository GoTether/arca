<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arca Tethr • Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12)}
    .tile{min-width:240px}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-3">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Arca Tethr</h1>
        <div id="crumbs" class="text-xs text-slate-400"></div>
      </div>
      <a href="./index.html" class="text-sm text-slate-300 underline underline-offset-4">Switch</a>
    </header>

    <!-- Status / debug line -->
    <section id="status" class="text-xs px-3 py-2 glass rounded-xl text-slate-300">Ready</section>

    <!-- Arca header -->
    <section class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 id="arcaName" class="font-semibold text-slate-100">Loading...</h2>
          <div id="arcaMeta" class="text-xs text-slate-400"></div>
        </div>
        <div class="flex gap-2">
          <button id="addItemBtn" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">
            Add Item
          </button>
        </div>
      </div>
    </section>

    <!-- Items -->
    <section>
      <div id="tiles" class="flex gap-3 overflow-x-auto pb-3"></div>
    </section>
  </main>

  <!-- Photo / Note Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-2">Add Photo / Note</h3>
      <div class="space-y-3">
        <input id="fileInput" type="file" accept="image/*" capture="environment"
               class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2" />
        <textarea id="noteInput" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                  placeholder="Note (optional)"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="modalOk" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- New Item Modal -->
  <div id="newItemModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-3">Add Item</h3>

      <label class="text-xs block mb-1">Name</label>
      <input id="newItemName" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none mb-3" placeholder="e.g., Pasta" />

      <div class="grid grid-cols-3 gap-2 items-end mb-3">
        <div class="col-span-2">
          <label class="text-xs block mb-1">Starting Quantity</label>
          <input id="newItemQty" type="number" min="0" step="1"
                 class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" value="1" />
        </div>
        <div class="flex gap-2">
          <button data-q="1"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+1</button>
          <button data-q="6"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+6</button>
          <button data-q="12" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+12</button>
        </div>
      </div>

      <label class="text-xs block mb-1">Photo (optional)</label>
      <input id="newItemFile" type="file" accept="image/*" capture="environment"
             class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2 mb-3" />

      <label class="text-xs block mb-1">Note (optional)</label>
      <textarea id="newItemNote" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                placeholder="Any details to remember..."></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button id="newItemCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="newItemSave" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2">
    <div id="toastInner" class="rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg">Saved</div>
  </div>

  <!-- Firebase compat (simplest) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    console.log("display compat (txn) v1");

    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    function $(sel){ return document.querySelector(sel); }
    function escapeHTML(s){
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
                      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
    function setStatus(msg){
      var el = $("#status"); if (!el) return;
      el.textContent = msg;
    }
    function showToast(msg, type){
      if (msg == null) msg = "Saved";
      var toast = $("#toast"), inner = $("#toastInner");
      if (!toast || !inner) return;
      inner.textContent = msg;
      inner.className = "rounded-xl px-3 py-2 text-sm shadow-lg " + (type === "error" ? "bg-red-600 text-white" : "bg-slate-800 text-slate-100");
      toast.classList.remove("hidden"); setTimeout(function(){ toast.classList.add("hidden"); }, 1200);
    }
    function flashSaved(itemId){
      var tile = document.querySelector('[data-tile="'+itemId+'"]');
      if (!tile) return; tile.classList.add("ring-2","ring-emerald-500");
      setTimeout(function(){ tile.classList.remove("ring-2","ring-emerald-500"); }, 700);
    }
    function fileToDataURL(file){
      return new Promise(function(resolve, reject){
        if (!file) return resolve(null);
        var reader = new FileReader();
        reader.onerror = reject;
        reader.onload = function(){ resolve(reader.result); };
        reader.readAsDataURL(file);
      });
    }
    function lastLines(notes){
      if (!notes) return "";
      var text = String(notes).replace(/\r/g,"");
      var lines = text.split("\n");
      var take = Math.max(1, Math.min(2, lines.length));
      var slice = lines.slice(-take).join(" / ");
      if (slice.length > 160) slice = slice.slice(0,160) + "...";
      return slice;
    }
    function firstImage(item){
      if (!item || !item.images || !item.images.length) return "";
      var img0 = item.images[0] || {};
      return img0.dataUrl || img0.url || "";
    }

    document.addEventListener("DOMContentLoaded", function(){
      var params = new URLSearchParams(location.search);
      var arcaId = (params.get("arcaId") || "").trim();
      if (!arcaId){
        document.body.innerHTML = '<main class="max-w-md mx-auto p-6 text-sm">Missing <b>arcaId</b>. <a href="./index.html" class="underline underline-offset-4">Go back</a>.</main>';
        return;
      }

      var crumbs = $("#crumbs");
      var arcaName = $("#arcaName");
      var arcaMeta = $("#arcaMeta");
      var tilesEl = $("#tiles");
      var addItemBtn = $("#addItemBtn");

      var modal = $("#modal");
      var modalOk = $("#modalOk");
      var modalCancel = $("#modalCancel");
      var fileInput = $("#fileInput");
      var noteInput = $("#noteInput");

      var newItemModal  = $("#newItemModal");
      var newItemName   = $("#newItemName");
      var newItemQty    = $("#newItemQty");
      var newItemFile   = $("#newItemFile");
      var newItemNote   = $("#newItemNote");
      var newItemSave   = $("#newItemSave");
      var newItemCancel = $("#newItemCancel");

      var items = {};
      var arcaRef  = db.ref("arca/" + arcaId);
      var itemsRef = db.ref("arca/" + arcaId + "/items");

      // Live arca info
      arcaRef.on("value", function(snap){
        var arca = snap.val() || {};
        arcaName.textContent = arca.name ? arca.name : arcaId;
        var bits = [];
        if (arca.type) bits.push(arca.type);
        if (arca.location) bits.push(arca.location);
        arcaMeta.textContent = bits.join(" • ");
        crumbs.textContent = arca.name ? arca.name : arcaId;
      });

      // Live items
      itemsRef.on("value", function(snap){
        items = snap.val() || {};
        renderItems();
      });

      function renderItems(){
        tilesEl.innerHTML = "";
        var ids = Object.keys(items);
        if (ids.length === 0){
          tilesEl.innerHTML = '<div class="glass p-4 rounded-2xl text-sm text-slate-300">No items yet. Use "Add Item".</div>';
          return;
        }
        ids.forEach(function(id){
          var item = items[id] || {};
          var imgSrc = firstImage(item);
          var notePrev = lastLines(item.notes);

          var tile = document.createElement("div");
          tile.className = "tile glass rounded-2xl p-3 relative";
          tile.setAttribute("data-tile", id);

          var html = '';
          html += '<div class="w-full aspect-video rounded-xl bg-slate-800 overflow-hidden mb-2">';
          if (imgSrc){
            html += '<img src="'+imgSrc+'" class="w-full h-full object-cover" alt="">';
          } else {
            html += '<div class="w-full h-full flex items-center justify-center text-xs text-slate-500">No Photo</div>';
          }
          html += '</div>';
          html += '<div class="font-semibold">'+escapeHTML(item.name || 'Unnamed')+'</div>';
          html += '<div class="text-xs text-slate-400">Qty: <span class="font-mono">'+(item.qty || 0)+'</span></div>';
          if (notePrev){
            html += '<div class="text-xs text-slate-300 mt-1"><span class="opacity-70">Note: </span>'+escapeHTML(notePrev)+'</div>';
          }
          html += '<div class="mt-3 grid grid-cols-3 gap-2">';
          html += '  <button data-act="photo" data-id="'+id+'" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Photo/Note</button>';
          html += '  <button data-act="minus" data-id="'+id+'" class="rounded-xl bg-red-500/80 hover:bg-red-500 text-slate-900 font-semibold px-0 py-2 text-lg">-</button>';
          html += '  <button data-act="plus"  data-id="'+id+'" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-0 py-2 text-lg">+</button>';
          html += '</div>';

          tile.innerHTML = html;
          Array.prototype.forEach.call(tile.querySelectorAll("button"), function(b){
            b.addEventListener("click", onTileAction);
          });
          tilesEl.appendChild(tile);
        });
      }

      // Qty adjust (works for you already)
      function adjustQty(itemId, delta){
        var qtyRef = db.ref("arca/" + arcaId + "/items/" + itemId + "/qty");
        qtyRef.transaction(function(current){
          var base = current || 0;
          var next = base + delta;
          if (next < 0) next = 0;
          return next;
        }, function(err){
          if (err){ console.error(err); showToast("Error updating qty","error"); }
          else {
            db.ref("arca/" + arcaId + "/items/" + itemId).update({ lastUpdated: Date.now() });
            showToast(delta > 0 ? "+1" : "-1");
            flashSaved(itemId);
          }
        });
      }

      function onTileAction(e){
        var id = e.currentTarget.getAttribute("data-id");
        var act = e.currentTarget.getAttribute("data-act");
        if (act === "minus") adjustQty(id, -1);
        if (act === "plus")  adjustQty(id, +1);
        if (act === "photo") openPhotoModal(id);
      }

      function openPhotoModal(itemId){
        modal.setAttribute("data-item-id", itemId);
        if (fileInput) fileInput.value = "";
        if (noteInput) noteInput.value = "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      modalCancel.addEventListener("click", function(){
        modal.classList.add("hidden"); modal.classList.remove("flex");
      });

      // --- Transactional save of photo/note (cannot be ignored) ---
      modalOk.addEventListener("click", function(){
        var itemId = modal.getAttribute("data-item-id");
        var file = (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;
        var note = noteInput ? (noteInput.value || "").trim() : "";

        modalOk.disabled = true; modalOk.textContent = "Saving...";
        setStatus("Saving note/photo to items/"+itemId+" …");

        fileToDataURL(file).then(function(dataUrl){
          var itemRef = db.ref("arca/" + arcaId + "/items/" + itemId);
          return itemRef.transaction(function(current){
            var now = Date.now();
            var item = current || {};
            // ensure structures
            if (!Array.isArray(item.images)) item.images = [];
            if (dataUrl){ item.images.unshift({ dataUrl: dataUrl, takenAt: now }); item.images = item.images.slice(0,6); }
            if (note){ item.notes = item.notes ? (item.notes + "\n" + note) : note; }
            item.lastUpdated = now;
            return item;
          });
        }).then(function(result){
          console.log("txn result:", result);
          if (result && result.committed){
            showToast("Saved");
            setStatus("Saved ✓");
            var id = modal.getAttribute("data-item-id");
            flashSaved(id);
          } else {
            setStatus("No changes committed (txn not needed).");
          }
        }).catch(function(err){
          console.error("save txn error", err);
          setStatus("Save failed: " + (err && err.message ? err.message : String(err)));
          showToast("Error saving","error");
        }).finally(function(){
          modalOk.disabled = false; modalOk.textContent = "Save";
          modal.classList.add("hidden"); modal.classList.remove("flex");
        });
      });

      // --- New Item (also via set) ---
      function openNewItemModal(){
        newItemName.value = ""; newItemQty.value = "1";
        newItemFile.value = ""; newItemNote.value = "";
        newItemModal.classList.remove("hidden"); newItemModal.classList.add("flex");
        setTimeout(function(){ newItemName.focus(); }, 30);
      }
      function closeNewItemModal(){
        newItemModal.classList.add("hidden"); newItemModal.classList.remove("flex");
      }
      addItemBtn.addEventListener("click", openNewItemModal);
      newItemCancel.addEventListener("click", closeNewItemModal);

      Array.prototype.forEach.call(newItemModal.querySelectorAll('button[data-q]'), function(btn){
        btn.addEventListener("click", function(ev){
          var add = parseInt(ev.currentTarget.getAttribute("data-q"), 10) || 0;
          var current = parseInt(newItemQty.value || "0", 10) || 0;
          newItemQty.value = String(current + add);
        });
      });

      newItemSave.addEventListener("click", function(){
        var name = (newItemName.value || "").trim();
        var qty  = Math.max(0, parseInt(newItemQty.value || "0", 10) || 0);
        var file = (newItemFile.files && newItemFile.files[0]) ? newItemFile.files[0] : null;
        var note = (newItemNote.value || "").trim();
        if (!name){ showToast("Name is required","error"); return; }

        var now = Date.now();
        var newId = "item-" + now + "-" + Math.floor(Math.random()*100000);

        setStatus("Creating item "+newId+" …");

        fileToDataURL(file).then(function(dataUrl){
          var images = dataUrl ? [{ dataUrl: dataUrl, takenAt: now }] : [];
          return db.ref("arca/" + arcaId + "/items/" + newId).set({
            name: name,
            qty: qty,
            images: images,
            notes: note || "",
            createdAt: now,
            lastUpdated: now
          });
        }).then(function(){
          closeNewItemModal(); showToast("Item saved");
          setStatus("Item created ✓");
          setTimeout(function(){ flashSaved(newId); }, 250);
        }).catch(function(e){
          console.error(e); showToast("Error saving item","error");
          setStatus("Item save failed: " + (e && e.message ? e.message : String(e)));
        });
      });
    });
  </script>
</body>
</html>
