<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arca Tethr • Start</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
    .card{max-width:520px}
    .hint{font-size:11px}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-3xl mx-auto p-4">
    <header class="mb-4">
      <h1 class="text-2xl font-semibold">Arca Tethr</h1>
      <p class="text-slate-400 text-sm">Scan a tag or enter an ID to view or create an Arca.</p>
    </header>

    <!-- Status / messages -->
    <div id="status" class="hidden mb-3 text-sm"></div>

    <!-- Landing: enter an ID -->
    <section id="enterId" class="glass rounded-2xl p-4 card hidden">
      <h2 class="font-semibold mb-2">Open an Arca</h2>
      <label class="text-xs block mb-1">Arca ID (from tag)</label>
      <div class="flex gap-2">
        <input id="idInput" class="flex-1 rounded-xl px-3 py-2 bg-slate-800/60 outline-none" placeholder="e.g., ARCA-TAG1" />
        <button id="openBtn" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-4">Go</button>
      </div>
      <div id="enterHelp" class="hint text-slate-400 mt-2">We’ll look it up. If it’s new, you can create it.</div>
    </section>

    <!-- Create form (shown when ID is new) -->
    <section id="createForm" class="glass rounded-2xl p-4 card hidden mt-4">
      <h2 class="font-semibold mb-2">Create a new Arca</h2>
      <div class="grid gap-3">
        <div>
          <label class="text-xs block mb-1">Arca ID</label>
          <input id="newId" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" readonly />
          <div class="hint text-slate-400 mt-1">This comes from the tag / URL. It’s the address used to open this Arca.</div>
        </div>
        <div>
          <label class="text-xs block mb-1">Name</label>
          <input id="newName" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" placeholder="e.g., Pantry • Bin A" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs block mb-1">Type (optional)</label>
            <select id="newType" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none">
              <option value="">—</option>
              <option>Container</option>
              <option>Drawer</option>
              <option>Box</option>
              <option>Shelf</option>
              <option>Room</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="text-xs block mb-1">Location (optional)</label>
            <input id="newLoc" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" placeholder="e.g., Kitchen / Pantry" />
          </div>
        </div>
      </div>
      <div class="mt-4 flex items-center justify-end gap-2">
        <button id="cancelCreate" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="saveCreate" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-4 py-2">Create</button>
      </div>
    </section>

    <!-- Checking card (shown while verifying id in URL) -->
    <section id="checking" class="glass rounded-2xl p-4 card hidden mt-4">
      <div class="flex items-center gap-3">
        <div class="w-4 h-4 rounded-full border-2 border-emerald-400 border-t-transparent animate-spin"></div>
        <div id="checkingMsg" class="text-sm">Checking ID…</div>
      </div>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    // --- Firebase ---
    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // --- Helpers ---
    function $(s){ return document.querySelector(s); }
    function show(el, on){ el.classList.toggle("hidden", !on); }
    function setStatus(msg, ok){
      var el = $("#status");
      if (!msg){ el.classList.add("hidden"); return; }
      el.textContent = msg;
      el.className = ok === false ? "mb-3 text-sm text-red-300" : "mb-3 text-sm text-emerald-300";
      el.classList.remove("hidden");
    }
    function sanitizeId(raw){
      return (raw||"").trim();
    }
    function goDisplay(id){
      location.href = "./display.html?arcaId=" + encodeURIComponent(id);
    }
    function checkExists(id){
      return db.ref("arca/"+id).once("value").then(function(s){ return !!s.val(); });
    }
    function createArca(id, name, type, loc){
      var now = Date.now();
      return db.ref("arca/"+id).set({
        name: name || id,
        type: type || "",
        location: loc || "",
        createdAt: now,
        lastUpdated: now
      });
    }

    // --- Init ---
    document.addEventListener("DOMContentLoaded", function(){
      var params = new URLSearchParams(location.search);
      var idFromUrl = sanitizeId(params.get("id") || params.get("arcaId") || "");

      var enterId = $("#enterId");
      var createForm = $("#createForm");
      var checking = $("#checking");

      function showLanding(){
        show(checking, false);
        show(createForm, false);
        show(enterId, true);
        setStatus("", true);
        $("#idInput").focus();
      }

      function showCreate(id){
        $("#newId").value = id;
        $("#newName").value = "";
        $("#newType").value = "";
        $("#newLoc").value = "";
        show(enterId, false);
        show(checking, false);
        show(createForm, true);
        setStatus("ID not found. Create a new Arca?", true);
      }

      // Flow A/B: URL has an id → check it
      if (idFromUrl){
        show(enterId, false);
        show(createForm, false);
        show(checking, true);
        $("#checkingMsg").textContent = "Checking ID: " + idFromUrl + " …";
        checkExists(idFromUrl).then(function(exists){
          if (exists) {
            $("#checkingMsg").textContent = "Found. Opening…";
            goDisplay(idFromUrl);
          } else {
            showCreate(idFromUrl);
          }
        }).catch(function(e){
          showLanding();
          setStatus("Error checking ID: " + (e && e.message || e), false);
        });
      } else {
        // Flow C: No id → landing
        showLanding();
      }

      // Landing handlers
      $("#openBtn").addEventListener("click", function(){
        var id = sanitizeId($("#idInput").value);
        if (!id) { setStatus("Please enter an ID.", false); return; }
        setStatus("Looking up " + id + " …", true);
        checkExists(id).then(function(exists){
          if (exists) goDisplay(id);
          else showCreate(id);
        }).catch(function(e){
          setStatus("Error: " + (e && e.message || e), false);
        });
      });
      $("#idInput").addEventListener("keydown", function(e){
        if (e.key === "Enter") $("#openBtn").click();
      });

      // Create form handlers
      $("#cancelCreate").addEventListener("click", function(){
        setStatus("", true);
        showLanding();
      });
      var creating = false;
      $("#saveCreate").addEventListener("click", function(){
        if (creating) return;
        var id   = $("#newId").value;
        var name = ($("#newName").value||"").trim() || id;
        var type = $("#newType").value || "";
        var loc  = $("#newLoc").value || "";

        creating = true;
        $("#saveCreate").disabled = true;
        $("#saveCreate").textContent = "Creating…";

        // double-check not taken (race condition)
        checkExists(id).then(function(exists){
          if (exists){
            setStatus("That ID was just created by someone else. Opening…", true);
            goDisplay(id);
            return;
          }
          return createArca(id, name, type, loc).then(function(){
            setStatus("Created ✓ Opening…", true);
            goDisplay(id);
          });
        }).catch(function(e){
          setStatus("Create failed: " + (e && e.message || e), false);
        }).finally(function(){
          creating = false;
          $("#saveCreate").disabled = false;
          $("#saveCreate").textContent = "Create";
        });
      });
    });
  </script>
</body>
</html>
