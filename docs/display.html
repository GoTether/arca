<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arca Tethr • Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.12)}
    .tile{min-width:240px}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Arca Tethr</h1>
        <div id="crumbs" class="text-xs text-slate-400"></div>
      </div>
      <a href="./index.html" class="text-sm text-slate-300 underline underline-offset-4">Switch</a>
    </header>

    <!-- Arca header -->
    <section class="glass p-4 rounded-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 id="arcaName" class="font-semibold text-slate-100">Loading…</h2>
          <div id="arcaMeta" class="text-xs text-slate-400"></div>
        </div>
        <div class="flex gap-2">
          <button id="addItemBtn" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">
            Add Item
          </button>
        </div>
      </div>
    </section>

    <!-- Items (horizontal tiles) -->
    <section>
      <div id="tiles" class="flex gap-3 overflow-x-auto pb-3"></div>
    </section>
  </main>

  <!-- Photo / Note Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-2">Add Photo / Note</h3>
      <div class="space-y-3">
        <input id="fileInput" type="file" accept="image/*" capture="environment"
               class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2" />
        <textarea id="noteInput" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                  placeholder="Note (optional)"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="modalOk" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- New Item Modal -->
  <div id="newItemModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-md w-full p-4">
      <h3 class="font-semibold mb-3">Add Item</h3>

      <label class="text-xs block mb-1">Name</label>
      <input id="newItemName" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none mb-3" placeholder="e.g., Pasta" />

      <div class="grid grid-cols-3 gap-2 items-end mb-3">
        <div class="col-span-2">
          <label class="text-xs block mb-1">Starting Quantity</label>
          <input id="newItemQty" type="number" min="0" step="1"
                 class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" value="1" />
        </div>
        <div class="flex gap-2">
          <button data-q="1"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+1</button>
          <button data-q="6"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+6</button>
          <button data-q="12" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+12</button>
        </div>
      </div>

      <label class="text-xs block mb-1">Photo (optional)</label>
      <input id="newItemFile" type="file" accept="image/*" capture="environment"
             class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2 mb-3" />

      <label class="text-xs block mb-1">Note (optional)</label>
      <textarea id="newItemNote" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                placeholder="Any details to remember…"></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button id="newItemCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="newItemSave" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2">
    <div id="toastInner" class="rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg">Saved</div>
  </div>

  <!-- Inline logic (no external file, no backticks) -->
  <script type="module">
    console.log("display inline safe v2");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    var app = initializeApp(firebaseConfig);
    var db = getDatabase(app);
    var storage = getStorage(app);

    var STORAGE_ROOT = "arca-dev";
    function $(sel){ return document.querySelector(sel); }

    function showToast(msg, type){
      if (msg == null) msg = "Saved";
      if (type == null) type = "ok";
      var toast = $("#toast");
      var inner = $("#toastInner");
      if (!toast || !inner) return;
      inner.textContent = msg;
      inner.className = "rounded-xl px-3 py-2 text-sm shadow-lg " + (type === "ok" ? "bg-slate-800 text-slate-100" : "bg-red-600 text-white");
      toast.classList.remove("hidden");
      setTimeout(function(){ toast.classList.add("hidden"); }, 1200);
    }
    function flashSaved(itemId){
      var tilesEl = $("#tiles");
      if (!tilesEl) return;
      var tile = tilesEl.querySelector('[data-tile="'+itemId+'"]');
      if (!tile) return;
      tile.classList.add("ring-2","ring-emerald-500");
      var chip = tile.querySelector(".saved-chip");
      if (!chip){
        chip = document.createElement("div");
        chip.className = "absolute top-2 right-2 text-xs bg-emerald-600/90 text-white px-2 py-0.5 rounded-full";
        chip.textContent = "✓ Saved";
        tile.appendChild(chip);
      } else {
        chip.classList.remove("hidden");
      }
      setTimeout(function(){
        tile.classList.remove("ring-2","ring-emerald-500");
        chip.classList.add("hidden");
      }, 700);
    }
    async function downscale(file, maxDim, mime, quality){
      if (maxDim == null) maxDim = 1200;
      if (mime == null) mime = "image/jpeg";
      if (quality == null) quality = 0.85;
      var img = await new Promise(function(res){
        var i = new Image();
        i.onload = function(){ res(i); };
        i.src = URL.createObjectURL(file);
      });
      var scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      if (scale === 1) return file;
      var c = document.createElement("canvas");
      c.width = Math.round(img.width * scale);
      c.height = Math.round(img.height * scale);
      c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);
      var blob = await new Promise(function(res){ c.toBlob(res, mime, quality); });
      return new File([blob], file.name.replace(/\.\w+$/, "") + ".jpg", {type:mime});
    }

    window.addEventListener("DOMContentLoaded", function(){
      var params = new URLSearchParams(location.search);
      var arcaId = (params.get("arcaId") || "").trim();

      if (!arcaId){
        document.body.innerHTML = '<main class="max-w-md mx-auto p-6 text-sm">Missing <b>arcaId</b>. <a href="./index.html" class="underline underline-offset-4">Go back</a>.</main>';
        return;
      }

      var crumbs = $("#crumbs");
      var arcaName = $("#arcaName");
      var arcaMeta = $("#arcaMeta");
      var tilesEl = $("#tiles");
      var addItemBtn = $("#addItemBtn");

      var modal = $("#modal");
      var modalOk = $("#modalOk");
      var modalCancel = $("#modalCancel");
      var fileInput = $("#fileInput");
      var noteInput = $("#noteInput");

      var newItemModal  = $("#newItemModal");
      var newItemName   = $("#newItemName");
      var newItemQty    = $("#newItemQty");
      var newItemFile   = $("#newItemFile");
      var newItemNote   = $("#newItemNote");
      var newItemSave   = $("#newItemSave");
      var newItemCancel = $("#newItemCancel");

      var arca = null;
      var items = {};
      var arcaRef  = ref(db, "arca/" + arcaId);
      var itemsRef = ref(db, "arca/" + arcaId + "/items");

      onValue(arcaRef, function(snap){
        arca = snap.val();
        if (arcaName) arcaName.textContent = (arca && arca.name) ? arca.name : arcaId;
        var bits = [];
        if (arca && arca.type) bits.push(arca.type);
        if (arca && arca.location) bits.push(arca.location);
        if (arcaMeta) arcaMeta.textContent = bits.join(" • ");
        if (crumbs) crumbs.textContent = (arca && arca.name) ? arca.name : arcaId;
      });

      onValue(itemsRef, function(snap){
        items = snap.val() || {};
        renderItems();
      });

      function renderItems(){
        if (!tilesEl) return;
        tilesEl.innerHTML = "";
        var entries = Object.keys(items);
        if (entries.length === 0){
          tilesEl.innerHTML = '<div class="glass p-4 rounded-2xl text-sm text-slate-300">No items yet. Use “Add Item”.</div>';
          return;
        }
        for (var i=0;i<entries.length;i++){
          var id = entries[i];
          var item = items[id] || {};
          var imgUrl = (item.images && item.images[0] && item.images[0].url) ? item.images[0].url : "";
          var tile = document.createElement("div");
          tile.className = "tile glass rounded-2xl p-3 relative";
          tile.setAttribute("data-tile", id);

          var html = '';
          html += '<div class="w-full aspect-video rounded-xl bg-slate-800 overflow-hidden mb-2">';
          if (imgUrl){
            html += '<img src="'+imgUrl+'" class="w-full h-full object-cover" alt="">';
          } else {
            html += '<div class="w-full h-full flex items-center justify-center text-xs text-slate-500">No Photo</div>';
          }
          html += '</div>';
          html += '<div class="font-semibold">'+(item.name || 'Unnamed')+'</div>';
          html += '<div class="text-xs text-slate-400">Qty: <span class="font-mono">'+(item.qty || 0)+'</span></div>';
          html += '<div class="mt-3 grid grid-cols-3 gap-2">';
          html += '  <button data-act="photo" data-id="'+id+'" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Photo/Note</button>';
          html += '  <button data-act="minus" data-id="'+id+'" class="rounded-xl bg-red-500/80 hover:bg-red-500 text-slate-900 font-semibold px-0 py-2 text-lg">−</button>';
          html += '  <button data-act="plus"  data-id="'+id+'" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-0 py-2 text-lg">+</button>';
          html += '</div>';

          tile.innerHTML = html;
          var btns = tile.querySelectorAll("button");
          for (var b=0;b<btns.length;b++){
            btns[b].addEventListener("click", onTileAction);
          }
          tilesEl.appendChild(tile);
        }
      }

      async function adjustQty(itemId, delta){
        try {
          var qtyRef = ref(db, "arca/" + arcaId + "/items/" + itemId + "/qty");
          await runTransaction(qtyRef, function(current){
            var base = current || 0;
            var next = base + delta;
            if (next < 0) next = 0;
            return next;
          });
          await update(ref(db, "arca/" + arcaId + "/items/" + itemId), { lastUpdated: Date.now() });
          showToast(delta > 0 ? "+1" : "−1", "ok");
          flashSaved(itemId);
        } catch (e) {
          console.error(e);
          showToast("Error updating qty", "error");
        }
      }
      function onTileAction(e){
        var id = e.currentTarget.getAttribute("data-id");
        var act = e.currentTarget.getAttribute("data-act");
        if (act === "minus") adjustQty(id, -1);
        if (act === "plus")  adjustQty(id, +1);
        if (act === "photo") openPhotoModal(id);
      }

      function openPhotoModal(itemId){
        if (!modal) return;
        modal.setAttribute("data-item-id", itemId);
        if (fileInput) fileInput.value = "";
        if (noteInput) noteInput.value = "";
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      if (modalCancel){
        modalCancel.addEventListener("click", function(){
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        });
      }
      if (modalOk){
        modalOk.addEventListener("click", async function(){
          if (!modal) return;
          var itemId = modal.getAttribute("data-item-id");
          var file = (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;
          var note = noteInput ? (noteInput.value || "").trim() : "";
          if (!file && !note){
            modal.classList.add("hidden"); modal.classList.remove("flex"); return;
          }
          try {
            var now = Date.now();
            var uploaded = null;

            if (file){
              var safe = await downscale(file, 1200, "image/jpeg", 0.85);
              var path = STORAGE_ROOT + "/" + arcaId + "/" + itemId + "/" + now + "-" + safe.name;
              var sr = sref(storage, path);
              await uploadBytes(sr, safe);
              var url = await getDownloadURL(sr);
              uploaded = { url: url, path: path, takenAt: now };
            }

            var itemRef = ref(db, "arca/" + arcaId + "/items/" + itemId);
            var snap = await get(itemRef);
            var item = snap.val() || {};
            var images = Array.isArray(item.images) ? item.images.slice() : [];

            var updates = { lastUpdated: now };
            if (uploaded){
              images.unshift(uploaded);
              updates.images = images.slice(0, 6);
            }
            if (note){
              var prev = item.notes || "";
              updates.notes = prev ? (prev + "\n" + note) : note;
            }

            await update(itemRef, updates);
            showToast("Saved", "ok");
            flashSaved(itemId);
          } catch (e) {
            console.error(e);
            showToast("Error saving", "error");
          } finally {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }
        });
      }

      function openNewItemModal(){
        if (!newItemModal) return;
        if (newItemName) newItemName.value = "";
        if (newItemQty)  newItemQty.value = "1";
        if (newItemFile) newItemFile.value = "";
        if (newItemNote) newItemNote.value = "";
        newItemModal.classList.remove("hidden");
        newItemModal.classList.add("flex");
        setTimeout(function(){ if (newItemName) newItemName.focus(); }, 30);
      }
      function closeNewItemModal(){
        if (!newItemModal) return;
        newItemModal.classList.add("hidden");
        newItemModal.classList.remove("flex");
      }
      if (addItemBtn) addItemBtn.addEventListener("click", openNewItemModal);
      if (newItemCancel) newItemCancel.addEventListener("click", closeNewItemModal);

      var quickBtns = newItemModal ? newItemModal.querySelectorAll('button[data-q]') : [];
      for (var q=0;q<quickBtns.length;q++){
        quickBtns[q].addEventListener("click", function(ev){
          var add = parseInt(ev.currentTarget.getAttribute("data-q"), 10) || 0;
          var current = parseInt(newItemQty ? (newItemQty.value || "0") : "0", 10) || 0;
          if (newItemQty) newItemQty.value = String(current + add);
        });
      }

      if (newItemSave){
        newItemSave.addEventListener("click", async function(){
          var name = newItemName ? (newItemName.value || "").trim() : "";
          var qty  = Math.max(0, parseInt(newItemQty ? (newItemQty.value || "0") : "0", 10) || 0);
          var file = (newItemFile && newItemFile.files && newItemFile.files[0]) ? newItemFile.files[0] : null;
          var note = newItemNote ? (newItemNote.value || "").trim() : "";
          if (!name){ showToast("Name is required", "error"); return; }

          try {
            var now = Date.now();
            var newId = "item-" + (self.crypto && crypto.randomUUID ? crypto.randomUUID() : String(now));
            var images = [];

            if (file){
              var safe = await downscale(file, 1200, "image/jpeg", 0.85);
              var path = STORAGE_ROOT + "/" + arcaId + "/" + newId + "/" + now + "-" + safe.name;
              var sr = sref(storage, path);
              await uploadBytes(sr, safe);
              var url = await getDownloadURL(sr);
              images = [{ url: url, path: path, takenAt: now }];
            }

            await set(ref(db, "arca/" + arcaId + "/items/" + newId), {
              name: name,
              qty: qty,
              images: images,
              notes: note || "",
              createdAt: now,
              lastUpdated: now
            });

            closeNewItemModal();
            showToast("Item saved", "ok");
            setTimeout(function(){ flashSaved(newId); }, 250);
          } catch (e) {
            console.error(e);
            showToast("Error saving item", "error");
          }
        });
      }
    });
  </script>
</body>
</html>
