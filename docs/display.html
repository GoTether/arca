<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arca Tethr • Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
    .tile{min-width:180px;width:180px}
    .truncate-1{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .snackbar{animation:fadeIn .12s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-3">
    <header class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-semibold">Arca Tethr</h1>
        <div id="crumbs" class="text-xs text-slate-400"></div>
      </div>
      <a href="./index.html" class="text-sm text-slate-300 underline underline-offset-4">Switch</a>
    </header>

    <section class="glass p-3 rounded-2xl">
      <div class="flex items-center justify-between gap-2">
        <div>
          <h2 id="arcaName" class="font-semibold text-slate-100">Loading...</h2>
          <div id="arcaMeta" class="text-xs text-slate-400"></div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Out-of-stock toggle chip -->
          <button id="toggleArchived" class="rounded-full bg-slate-800 hover:bg-slate-700 px-3 py-1.5 text-xs text-slate-200">
            Out of stock (0)
          </button>
          <button id="addItemBtn" class="rounded-lg bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">
            Add Item
          </button>
        </div>
      </div>
    </section>

    <!-- Available items -->
    <section>
      <h3 class="sr-only">Items</h3>
      <div id="tiles" class="flex gap-3 overflow-x-auto pb-2"></div>
    </section>

    <!-- Archived (collapsed by default) -->
    <section id="archivedSection" class="hidden">
      <div class="mt-2 text-xs text-slate-400">Out of stock</div>
      <div id="tilesArchived" class="flex gap-3 overflow-x-auto pb-2 mt-1"></div>
    </section>
  </main>

  <!-- Photo / Note Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-sm w-full p-4">
      <h3 class="font-semibold mb-2">Add Photo / Note</h3>
      <div class="space-y-3">
        <input id="fileInput" type="file" accept="image/*"
               class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2" />
        <textarea id="noteInput" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                  placeholder="Note (optional)"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modalCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="modalOk" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- New Item Modal -->
  <div id="newItemModal" class="hidden fixed inset-0 bg-black/60 items-center justify-center p-4">
    <div class="glass rounded-2xl max-w-sm w-full p-4">
      <h3 class="font-semibold mb-3">Add Item</h3>

      <label class="text-xs block mb-1">Name</label>
      <input id="newItemName" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none mb-3" placeholder="e.g., Pasta" />

      <div class="grid grid-cols-3 gap-2 items-end mb-3">
        <div class="col-span-2">
          <label class="text-xs block mb-1">Starting Quantity</label>
          <input id="newItemQty" type="number" min="0" step="1"
                 class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" value="1" />
        </div>
        <div class="flex gap-2">
          <button data-q="1"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+1</button>
          <button data-q="6"  class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+6</button>
          <button data-q="12" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-1 text-xs">+12</button>
        </div>
      </div>

      <label class="text-xs block mb-1">Photo (optional)</label>
      <input id="newItemFile" type="file" accept="image/*"
             class="w-full text-sm file:bg-slate-700 file:border-0 file:rounded-lg file:px-3 file:py-2 mb-3" />

      <label class="text-xs block mb-1">Note (optional)</label>
      <textarea id="newItemNote" rows="2" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                placeholder="Any details to remember..."></textarea>

      <div class="mt-4 flex justify-end gap-2">
        <button id="newItemCancel" class="rounded-xl bg-slate-700 hover:bg-slate-600 px-3 py-2 text-sm">Cancel</button>
        <button id="newItemSave" class="rounded-xl bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Save</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2">
    <div id="toastInner" class="rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg">Saved</div>
  </div>

  <!-- Snackbar with Undo -->
  <div id="snack" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2">
    <div class="snackbar rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg flex items-center gap-3">
      <span id="snackMsg">Moved to Out of stock</span>
      <button id="snackUndo" class="text-emerald-300 hover:text-emerald-200 font-semibold">Undo</button>
    </div>
  </div>

  <!-- Firebase compat (DB only) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // ---- Firebase ----
    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // ---- Helpers ----
    function $(s){ return document.querySelector(s); }
    function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }
    function toast(msg,bad){ var t=$("#toast"),i=$("#toastInner"); if(!t||!i)return; i.textContent=msg||"Saved"; i.className="rounded-xl px-3 py-2 text-sm shadow-lg "+(bad?"bg-red-600 text-white":"bg-slate-800 text-slate-100"); t.classList.remove("hidden"); setTimeout(function(){t.classList.add("hidden");},1200); }

    // Snackbar (Undo)
    var snackTimer=null, lastArchived=null;
    function showSnack(message, payload){
      $("#snackMsg").textContent = message || "Moved to Out of stock";
      lastArchived = payload || null;
      var s=$("#snack"); s.classList.remove("hidden");
      if (snackTimer) clearTimeout(snackTimer);
      snackTimer = setTimeout(function(){ s.classList.add("hidden"); lastArchived=null; }, 4000);
    }
    $("#snackUndo").addEventListener("click", function(){
      var s=$("#snack");
      if (!lastArchived) return s.classList.add("hidden");
      // Undo: set qty=1 and unarchive
      var ar = lastArchived;
      db.ref("arca/"+ar.arcaId+"/items/"+ar.itemId).update({
        qty: 1,
        archived: false,
        archivedAt: null,
        lastUpdated: Date.now()
      }).then(function(){
        toast("Restored");
      });
      s.classList.add("hidden");
      lastArchived = null;
      if (snackTimer) clearTimeout(snackTimer);
    });

    // ---- App ----
    document.addEventListener("DOMContentLoaded", function(){
      var arcaId = (new URLSearchParams(location.search).get("arcaId")||"").trim();
      if(!arcaId){
        document.body.innerHTML='<main class="max-w-md mx-auto p-6 text-sm">Missing arcaId. <a class="underline" href="./index.html">Go back</a>.</main>';
        return;
      }

      var tiles=$("#tiles"), tilesArchived=$("#tilesArchived");
      var archivedSection=$("#archivedSection");
      var toggleArchivedBtn=$("#toggleArchived");

      var addItemBtn=$("#addItemBtn");
      var modal=$("#modal"), modalOk=$("#modalOk"), modalCancel=$("#modalCancel"), fileInput=$("#fileInput"), noteInput=$("#noteInput");
      var newItemModal=$("#newItemModal"), newItemName=$("#newItemName"), newItemQty=$("#newItemQty"), newItemFile=$("#newItemFile"), newItemNote=$("#newItemNote"), newItemSave=$("#newItemSave"), newItemCancel=$("#newItemCancel");

      var arcaRef=db.ref("arca/"+arcaId);
      var itemsRef=db.ref("arca/"+arcaId+"/items");
      var items={};
      var showArchived=false;

      // Header
      arcaRef.on("value", function(s){
        var a=s.val()||{};
        $("#arcaName").textContent=a.name||arcaId;
        var bits=[]; if(a.type) bits.push(a.type); if(a.location) bits.push(a.location);
        $("#arcaMeta").textContent=bits.join(" • ");
        $("#crumbs").textContent=a.name||arcaId;
      });

      // Items
      itemsRef.on("value", function(s){
        items=s.val()||{};
        render();
      });

      toggleArchivedBtn.addEventListener("click", function(){
        showArchived = !showArchived;
        archivedSection.classList.toggle("hidden", !showArchived);
        render(); // update chip count state
      });

      function notePreview(t){
        if(!t) return "";
        var line=String(t).replace(/\r/g,"").split("\n").slice(-1)[0]||"";
        if(line.length>60) line=line.slice(0,60)+"...";
        return line;
      }
      function firstImage(it){
        if(!it||!it.images||!it.images.length) return "";
        var im=it.images[0]; return im.dataUrl||im.url||"";
      }

      function buildTile(id, it){
        var imgSrc=firstImage(it);
        var d=document.createElement("div");
        d.className="tile glass rounded-2xl p-2 relative";
        d.setAttribute("data-tile",id);

        var h='';
        // small contained thumb
        h+='<div class="w-full h-28 rounded-lg bg-slate-800/80 border border-slate-700 overflow-hidden flex items-center justify-center mb-2">';
        h+= imgSrc ? '<img src="'+imgSrc+'" class="max-h-full max-w-full object-contain" alt="">' : '<div class="text-[11px] text-slate-500">No Photo</div>';
        h+='</div>';

        h+='<div class="text-sm font-semibold truncate-1">'+esc(it.name||"Unnamed")+'</div>';
        var np=notePreview(it.notes);
        if(np){ h+='<div class="text-[11px] text-slate-300 truncate-1">'+esc(np)+'</div>'; }

        // stepper row
        h+='<div class="mt-2 grid grid-cols-3 items-center gap-2">';
        h+='  <button data-act="minus" data-id="'+id+'" class="rounded-lg bg-slate-700 hover:bg-slate-600 px-0 py-2 text-base">-</button>';
        h+='  <div class="text-center text-sm"><span class="text-slate-400">Qty</span> <span class="font-mono">'+(it.qty||0)+'</span></div>';
        h+='  <button data-act="plus"  data-id="'+id+'" class="rounded-lg bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-0 py-2 text-base">+</button>';
        h+='</div>';

        h+='<div class="mt-2">';
        h+='  <button data-act="photo" data-id="'+id+'" class="w-full rounded-lg bg-slate-700 hover:bg-slate-600 px-2 py-2 text-xs">Photo / Note</button>';
        h+='</div>';

        d.innerHTML=h;
        Array.prototype.forEach.call(d.querySelectorAll("button"), function(b){ b.addEventListener("click", onAction); });
        return d;
      }

      function render(){
        tiles.innerHTML=""; tilesArchived.innerHTML="";
        var ids=Object.keys(items);
        var archivedCount=0;

        ids.forEach(function(id){
          var it=items[id]||{};
          if (it.archived) archivedCount++;
        });

        // chip label
        toggleArchivedBtn.textContent = "Out of stock ("+archivedCount+")";

        // main
        ids.forEach(function(id){
          var it=items[id]||{};
          if (it.archived) return; // hidden from main
          tiles.appendChild(buildTile(id, it));
        });

        // archived section
        if (showArchived){
          ids.forEach(function(id){
            var it=items[id]||{};
            if (!it.archived) return;
            tilesArchived.appendChild(buildTile(id, it));
          });
        }
      }

      // Qty adjust with auto-archive + undo
      function adjustQty(itemId, delta){
        if (delta === 0) return;
        var itemRef = db.ref("arca/"+arcaId+"/items/"+itemId);

        // If decrement might hit zero, do it transactionally on the item object
        if (delta < 0) {
          itemRef.transaction(function(current){
            var it = current || {};
            var q = it.qty || 0;
            if (q <= 0) { it.qty = 0; return it; }
            q = q + delta;
            if (q < 0) q = 0;
            if (q === 0) {
              it.qty = 0;
              it.archived = true;
              it.archivedAt = Date.now();
              it.lastUpdated = it.archivedAt;
            } else {
              it.qty = q;
              it.lastUpdated = Date.now();
            }
            return it;
          }, function(err, committed, snap){
            if (err) { console.error(err); toast("Error updating qty", true); return; }
            var after = snap ? snap.val() : null;
            if (after && after.qty === 0 && after.archived) {
              showSnack("Moved to Out of stock", { arcaId: arcaId, itemId: itemId });
            } else {
              toast("-1");
            }
          });
          return;
        }

        // Simple increment path
        var qtyRef = db.ref("arca/"+arcaId+"/items/"+itemId+"/qty");
        qtyRef.transaction(function(cur){ var n=(cur||0)+delta; return n<0?0:n; }, function(err){
          if (err){ console.error(err); toast("Error updating qty", true); }
          else {
            // If it was archived and we added, unarchive automatically
            db.ref("arca/"+arcaId+"/items/"+itemId).update({
              archived: false,
              archivedAt: null,
              lastUpdated: Date.now()
            });
            toast("+1");
          }
        });
      }

      function onAction(e){
        var id=e.currentTarget.getAttribute("data-id");
        var act=e.currentTarget.getAttribute("data-act");
        if(act==="minus") return adjustQty(id,-1);
        if(act==="plus")  return adjustQty(id,+1);
        if(act==="photo") return openModal(id);
      }

      function openModal(itemId){
        modal.setAttribute("data-item-id", itemId);
        fileInput.value=""; noteInput.value="";
        modal.classList.remove("hidden"); modal.classList.add("flex");
      }
      modalCancel.addEventListener("click", function(){ modal.classList.add("hidden"); modal.classList.remove("flex"); });

      // Save Photo/Note (data URL MVP)
      modalOk.addEventListener("click", function(){
        var id=modal.getAttribute("data-item-id");
        var f=(fileInput.files&&fileInput.files[0])?fileInput.files[0]:null;
        var note=(noteInput.value||"").trim();

        modalOk.disabled=true; modalOk.textContent="Saving...";

        var p=Promise.resolve();
        if(note){
          p=p.then(function(){
            return db.ref("arca/"+arcaId+"/items/"+id+"/notes").transaction(function(prev){
              prev=prev||""; return prev? (prev+"\n"+note) : note;
            });
          });
        }
        if(f){
          p=p.then(function(){ return fileToDataURL(f); })
             .then(function(dataUrl){
               return db.ref("arca/"+arcaId+"/items/"+id+"/images").transaction(function(arr){
                 arr=Array.isArray(arr)?arr:[]; arr.unshift({dataUrl:dataUrl, takenAt:Date.now()});
                 return arr.slice(0,6);
               });
             });
        }
        p.then(function(){ toast("Saved"); })
         .catch(function(e){ console.error(e); toast("Save failed",true); })
         .finally(function(){ modalOk.disabled=false; modalOk.textContent="Save"; modal.classList.add("hidden"); modal.classList.remove("flex"); });
      });

      function fileToDataURL(file){
        return new Promise(function(resolve,reject){
          var r=new FileReader(); r.onerror=reject; r.onload=function(){ resolve(r.result); };
          r.readAsDataURL(file);
        });
      }

      // New item
      addItemBtn.addEventListener("click", function(){
        newItemName.value=""; newItemQty.value="1"; newItemFile.value=""; newItemNote.value="";
        newItemModal.classList.remove("hidden"); newItemModal.classList.add("flex");
        setTimeout(function(){ newItemName.focus(); }, 30);
      });
      newItemCancel.addEventListener("click", function(){ newItemModal.classList.add("hidden"); newItemModal.classList.remove("flex"); });
      Array.prototype.forEach.call(newItemModal.querySelectorAll('button[data-q]'), function(b){
        b.addEventListener("click", function(ev){
          var add=parseInt(ev.currentTarget.getAttribute("data-q"),10)||0;
          var cur=parseInt(newItemQty.value||"0",10)||0;
          newItemQty.value=String(cur+add);
        });
      });
      newItemSave.addEventListener("click", function(){
        var name=(newItemName.value||"").trim();
        var qty =Math.max(0, parseInt(newItemQty.value||"0",10)||0);
        var f=(newItemFile.files&&newItemFile.files[0])?newItemFile.files[0]:null;
        var note=(newItemNote.value||"").trim();
        if(!name){ toast("Name is required",true); return; }

        var now=Date.now(), newId="item-"+now+"-"+Math.floor(Math.random()*100000);
        var chain=Promise.resolve(), images=[];
        if(f){ chain=chain.then(function(){ return fileToDataURL(f); }).then(function(d){ images=[{dataUrl:d,takenAt:now}]; }); }
        chain.then(function(){
          return db.ref("arca/"+arcaId+"/items/"+newId).set({
            name:name, qty:qty, images:images, notes:note||"", archived:false, archivedAt:null,
            createdAt:now, lastUpdated:now
          });
        }).then(function(){ newItemModal.classList.add("hidden"); newItemModal.classList.remove("flex"); toast("Item saved"); })
          .catch(function(e){ console.error(e); toast("Error saving item",true); });
      });
    });
  </script>
</body>
</html>
