<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Arcadash • My Arcas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
    .btn{border-radius:.75rem;padding:.5rem .75rem}
    .tile:hover{transform:translateY(-1px)}
    .tile{transition:transform .12s ease}
    .truncate-1{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Skeleton shimmer */
    .skel{position:relative; overflow:hidden; background:rgba(148,163,184,.15); border-radius:.5rem;}
    .skel::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.18) 50%, rgba(255,255,255,0) 100%);
      transform:translateX(-100%); animation:shimmer 1.1s infinite;
    }
    @keyframes shimmer{to{transform:translateX(100%)}}

    /* Photo placeholder (no image yet) */
    .ph-photo{
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      background:
        radial-gradient(60% 60% at 30% 20%, rgba(16,185,129,.18), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.65));
      border:1px dashed rgba(148,163,184,.35);
      border-radius:.5rem;
      color:rgba(226,232,240,.7);
      font-size:11px;
      letter-spacing:.02em;
    }
    .ph-photo svg{opacity:.6}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-4">

    <!-- Header -->
    <header class="flex items-center justify-between">
      <h1 class="text-xl font-semibold">Arcadash</h1>
      <div class="flex items-center gap-2">
        <a href="./display.html" class="btn bg-slate-800 hover:bg-slate-700 text-sm">Open an Arca</a>
      </div>
    </header>

    <!-- Toolbar -->
    <section class="glass rounded-2xl p-3">
      <div class="grid gap-3 md:grid-cols-3 md:items-center">
        <div class="md:col-span-2">
          <label class="text-xs block mb-1">Search</label>
          <input id="search" placeholder="Filter by name, ID, type, or location…"
                 class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"/>
        </div>
        <div class="flex items-end md:justify-end gap-2">
          <button id="selectToggle" class="btn bg-slate-800 hover:bg-slate-700 text-sm">Select</button>
          <button id="reloadBtn" class="btn bg-slate-800 hover:bg-slate-700 text-sm">Reload</button>
        </div>
      </div>

      <!-- Bulk editor -->
      <div id="bulkBar" class="hidden mt-3 border-t border-slate-700 pt-3">
        <div class="flex flex-wrap items-center gap-2">
          <span id="selCount" class="text-sm text-slate-300 mr-2">0 selected</span>
          <input id="bulkLocation" placeholder="Set new location…"
                 class="rounded-xl px-3 py-2 bg-slate-800/60 outline-none text-sm"/>
          <button id="applyLocation" class="btn bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold text-sm">Apply Location</button>
          <button id="clearSel" class="btn bg-slate-700 hover:bg-slate-600 text-sm">Clear Selection</button>
        </div>
        <div class="text-[11px] text-slate-400 mt-1">Tip: use the checkboxes on cards (or “Select all”) to choose targets.</div>
      </div>
    </section>

    <!-- Groups -->
    <section id="groups" class="space-y-6">
      <div id="grpPinned" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm uppercase tracking-wide text-slate-300/90">Pinned (Arcadash)</h2>
          <div class="flex items-center gap-2">
            <button id="selAllPinned" class="hidden btn bg-slate-800 hover:bg-slate-700 text-xs">Select all</button>
          </div>
        </div>
        <div id="gridPinned" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      </div>

      <div id="grpCreated" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-sm uppercase tracking-wide text-slate-300/90">Created on this device</h2>
          <div class="flex items-center gap-2">
            <button id="selAllCreated" class="hidden btn bg-slate-800 hover:bg-slate-700 text-xs">Select all</button>
          </div>
        </div>
        <div id="gridCreated" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
        <p id="createdHint" class="text-[11px] text-slate-400 mt-2 hidden">
          This list fills when you create arcas from this device.
        </p>
      </div>

      <div id="emptyState" class="hidden glass rounded-2xl p-6 text-center">
        <div class="text-sm text-slate-300">No arcas yet. Open one by ID on the <a class="underline" href="./display.html">Arca page</a> and click “Add to my Arcadash”.</div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-20 left-1/2 -translate-x-1/2">
    <div id="toastInner" class="rounded-xl bg-slate-800 text-slate-100 px-3 py-2 text-sm shadow-lg">Saved</div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // --- Firebase ---
    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // --- Helpers ---
    const $ = s => document.querySelector(s);
    function toast(msg,bad){var t=$("#toast"),i=$("#toastInner"); if(!t||!i)return; i.textContent=msg||"Saved"; i.className="rounded-xl px-3 py-2 text-sm shadow-lg "+(bad?"bg-red-600 text-white":"bg-slate-800 text-slate-100"); t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"),1200)}
    function uniq(arr){return [...new Set(arr||[])]}
    function getPins(){ try { return JSON.parse(localStorage.getItem("arcaPins")||"[]"); } catch(e){ return []; } }
    function setPins(p){ localStorage.setItem("arcaPins", JSON.stringify(uniq(p))); }
    function getCreated(){ try { return JSON.parse(localStorage.getItem("arcaCreated")||"[]"); } catch(e){ return []; } }
    function setCreated(a){ localStorage.setItem("arcaCreated", JSON.stringify(uniq(a))); }
    function esc(s){return String(s||"").replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) )}

    // --- State ---
    let selectionMode = false;
    let selected = new Set();
    const cache = {}; // id -> {loaded?, missing?, id, name, type, location, notes, photo}

    // --- UI Refs ---
    const search = $("#search");
    const selectToggle = $("#selectToggle");
    const reloadBtn = $("#reloadBtn");
    const bulkBar = $("#bulkBar");
    const selCount = $("#selCount");
    const bulkLocation = $("#bulkLocation");
    const applyLocation = $("#applyLocation");
    const clearSel = $("#clearSel");

    const grpPinned = $("#grpPinned");
    const gridPinned = $("#gridPinned");
    const selAllPinned = $("#selAllPinned");

    const grpCreated = $("#grpCreated");
    const gridCreated = $("#gridCreated");
    const selAllCreated = $("#selAllCreated");
    const createdHint = $("#createdHint");

    const emptyState = $("#emptyState");

    // --- Selection helpers ---
    function setSelectionMode(on){
      selectionMode = !!on;
      selectToggle.textContent = selectionMode ? "Done" : "Select";
      bulkBar.classList.toggle("hidden", !selectionMode);
      selAllPinned.classList.toggle("hidden", !selectionMode);
      selAllCreated.classList.toggle("hidden", !selectionMode);
      updateSelCount();
      renderAll();
    }
    function toggleSelect(id){
      if (selected.has(id)) selected.delete(id); else selected.add(id);
      updateSelCount(); renderAll();
    }
    function selectAll(ids){ ids.forEach(id => selected.add(id)); updateSelCount(); renderAll(); }
    function clearSelection(){ selected.clear(); updateSelCount(); renderAll(); }
    function updateSelCount(){ selCount.textContent = selected.size + " selected"; }

    selectToggle.addEventListener("click", ()=> setSelectionMode(!selectionMode));
    clearSel.addEventListener("click", clearSelection);
    selAllPinned.addEventListener("click", ()=> selectAll(visibleIdsFrom(gridPinned)));
    selAllCreated.addEventListener("click", ()=> selectAll(visibleIdsFrom(gridCreated)));

    function visibleIdsFrom(grid){
      return Array.from(grid.querySelectorAll("[data-id]")).map(el => el.getAttribute("data-id"));
    }

    // --- Fetching ---
    function attachListen(id){
      if (cache[id]?.listening) return;
      cache[id] = cache[id] || {};
      cache[id].listening = true;
      cache[id].loaded = false;
      db.ref("arca/"+id).on("value", snap=>{
        const v = snap.val();
        if (!v) { cache[id] = { id, loaded:true, missing:true }; renderAll(); return; }
        cache[id] = {
          id,
          loaded: true,
          name: v.name || id,
          type: v.type || "",
          location: v.location || "",
          notes: v.notes || "",
          photo: v.photo && (v.photo.dataUrl || v.photo.url) || ""
        };
        renderAll();
      });
    }

    function detachAll(){
      Object.keys(cache).forEach(id => db.ref("arca/"+id).off());
    }

    // --- Filter ---
    function matchesFilter(info, q){
      if (!q) return true;
      q = q.toLowerCase().trim();
      if (!info.loaded) return true; // keep skeletons visible
      return (info.name||"").toLowerCase().includes(q)
          || (info.id||"").toLowerCase().includes(q)
          || (info.type||"").toLowerCase().includes(q)
          || (info.location||"").toLowerCase().includes(q);
    }
    search.addEventListener("input", renderAll);

    // --- Meta line (no placeholder strings) ---
    function metaMarkup(info){
      if (!info.loaded) return '<div class="mt-1 h-3 skel"></div>';
      const parts = [];
      if (info.type) parts.push(esc(info.type));
      if (info.location) parts.push(esc(info.location));
      if (!parts.length) return '';
      return `<div class="text-xs text-slate-300/90 mt-0.5 truncate-1">${parts.join(" • ")}</div>`;
    }

    // --- Build card ---
    function buildCard(info, pinnedGroup){
      const id = info.id;
      const selectedNow = selected.has(id);
      const match = matchesFilter(info, search.value);
      const isLoading = !info.loaded;
      const hasPhoto = !!info.photo;

      const wrap = document.createElement("div");
      wrap.dataset.id = id;
      wrap.className = (match ? "" : "hidden ") + "tile glass rounded-2xl p-2";

      // Photo area:
      const photoHTML = isLoading
        ? `<div class="w-full aspect-[4/3] skel"></div>`
        : (hasPhoto
            ? `<img src="${esc(info.photo)}" class="w-full aspect-[4/3] object-cover rounded-md border border-slate-700/70" alt="">`
            : `<div class="w-full aspect-[4/3] ph-photo">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                   <path d="M4 7a3 3 0 0 1 3-3h2l1.2-1.6A2 2 0 0 1 12.8 2h2.4a2 2 0 0 1 1.6.8L18 4h2a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V7zm8 3.5a4.5 4.5 0 1 0 .001 9.001A4.5 4.5 0 0 0 12 10.5z"/>
                 </svg>
                 <span>No picture</span>
               </div>`);

      const nameHTML = isLoading
        ? `<div class="h-4 skel rounded-md"></div>`
        : `<div class="font-semibold truncate-1">${esc(info.name || id)}</div>`;

      const idHTML = isLoading
        ? `<div class="h-3 mt-1 skel rounded-md"></div>`
        : `<div class="text-[11px] text-slate-400 font-mono truncate-1">${esc(id)}</div>`;

      const actionsHTML = isLoading
        ? `<div class="mt-2 h-8 skel rounded-lg"></div>`
        : `<div class="mt-2 flex items-center justify-between gap-2">
             <a href="./display.html?arcaId=${encodeURIComponent(id)}" class="btn bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold text-xs">Open</a>
             <div class="flex items-center gap-2">
               ${pinnedGroup ? `<button class="btn bg-slate-700 hover:bg-slate-600 text-xs" data-act="unpin" data-id="${id}">Unpin</button>` : ""}
             </div>
           </div>`;

      wrap.innerHTML = `
        <div class="rounded-lg overflow-hidden border border-slate-700 bg-slate-800/50">
          <div class="relative p-2 pb-0">
            ${photoHTML}
            ${selectionMode && !isLoading ? `
              <label class="absolute top-3 left-3 bg-slate-900/70 border border-slate-700 rounded-md px-1.5 py-1 text-xs flex items-center gap-1">
                <input type="checkbox" ${selectedNow ? "checked": ""} class="accent-emerald-500" data-act="sel" data-id="${id}"/>
                Select
              </label>` : ""}
          </div>
          <div class="p-2">
            ${nameHTML}
            ${idHTML}
            ${metaMarkup(info)}
            ${actionsHTML}
          </div>
        </div>
      `;

      // interactions
      wrap.addEventListener("click", (e)=>{
        const actBtn = e.target.closest("[data-act]");
        if (actBtn){
          const act = actBtn.getAttribute("data-act");
          const tid = actBtn.getAttribute("data-id");
          if (act === "sel"){ e.stopPropagation(); toggleSelect(tid); }
          else if (act === "unpin"){
            e.stopPropagation();
            let pins = getPins().filter(x => x !== tid);
            setPins(pins);
            toast("Unpinned");
            refresh();
          }
          return;
        }
        if (selectionMode && !isLoading){
          if (!e.target.closest("a")) toggleSelect(id);
        }
      });

      return wrap;
    }

    // --- Bulk: Location ---
    applyLocation.addEventListener("click", async ()=>{
      const ids = Array.from(selected);
      const val = (bulkLocation.value || "").trim();
      if (!ids.length){ toast("Select some arcas first", true); return; }
      try{
        await Promise.all(ids.map(id => db.ref("arca/"+id).update({ location: val, lastUpdated: Date.now() })));
        toast("Location updated");
        bulkLocation.value = "";
      }catch(e){
        console.error(e); toast("Update failed", true);
      }
    });

    // --- Rendering groups ---
    function renderGroup(gridEl, ids, pinnedGroup){
      gridEl.innerHTML = "";
      ids.forEach(id=>{
        const info = cache[id] || { id, loaded:false };
        gridEl.appendChild(buildCard(info, pinnedGroup));
      });
    }

    function renderAll(){
      const pids = getPins();
      const cids = getCreated();

      const anyPinned = pids.length > 0;
      const anyCreated = cids.length > 0;

      grpPinned.classList.toggle("hidden", !anyPinned);
      grpCreated.classList.toggle("hidden", !anyCreated);
      createdHint.classList.toggle("hidden", anyCreated);

      emptyState.classList.toggle("hidden", (anyPinned || anyCreated));

      renderGroup(gridPinned, pids, true);
      renderGroup(gridCreated, cids, false);
    }

    // --- Refresh all data ---
    function refresh(){
      const ids = uniq([...getPins(), ...getCreated()]);
      ids.forEach(attachListen);
      renderAll();
    }

    // --- Reload button ---
    reloadBtn.addEventListener("click", ()=>{
      refresh();
      toast("Reloaded");
    });

    // --- Boot ---
    document.addEventListener("DOMContentLoaded", ()=>{
      refresh();
    });

    // --- Keyboard shortcut: 's' toggles selection mode ---
    document.addEventListener("keydown", (e)=>{
      if (e.key.toLowerCase() === 's') setSelectionMode(!selectionMode);
    });
  </script>
</body>
</html>
