<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Arca Tethr • Arcadash</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .glass{background:rgba(255,255,255,.07);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.12)}
    .truncate-1{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  </style>
</head>
<body class="min-h-full bg-gradient-to-b from-slate-900 to-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <header class="flex items-center justify-between">
      <h1 class="text-xl font-semibold">My Arcadash</h1>
      <nav class="flex items-center gap-3 text-sm">
        <a href="./index.html" class="text-slate-300 hover:text-white">Scan / Open</a>
      </nav>
    </header>

    <!-- search/filter -->
    <section class="glass rounded-2xl p-4">
      <div class="grid md:grid-cols-3 gap-3">
        <div class="md:col-span-2">
          <label class="text-xs block mb-1">Search in pinned arcas</label>
          <input id="q" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none"
                 placeholder="e.g., cables, pasta, batteries"/>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-xs block mb-1">Type</label>
            <select id="fType" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none">
              <option value="">Any</option>
              <option>Container</option><option>Drawer</option><option>Box</option>
              <option>Shelf</option><option>Room</option><option>Other</option>
            </select>
          </div>
          <label class="inline-flex items-center gap-2 text-xs text-slate-300 self-end">
            <input id="onlyInStock" type="checkbox" class="accent-emerald-500"/> Qty &gt; 0
          </label>
        </div>
      </div>
      <div class="mt-3 flex items-center justify-between">
        <div id="stats" class="text-xs text-slate-400">0 results</div>
        <div class="flex items-center gap-2">
          <button id="clearBtn" class="rounded-lg bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm">Clear</button>
        </div>
      </div>
    </section>

    <!-- empty state -->
    <section id="empty" class="glass rounded-2xl p-5 text-sm text-slate-300 hidden">
      You don’t have any pinned arcas yet. Open an arca and tap
      <span class="text-slate-100 font-medium">“Add to my Arcadash”</span>.
    </section>

    <!-- results -->
    <section id="results" class="space-y-3"></section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script>
    // Firebase (same project)
    var firebaseConfig = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    // local pins
    function getPins(){ try { return JSON.parse(localStorage.getItem("arcaPins")||"[]"); } catch(e){ return []; } }
    function setPins(pins){ localStorage.setItem("arcaPins", JSON.stringify([...new Set(pins)])); }
    function removePin(id){ setPins(getPins().filter(x => x !== id)); }

    const q = document.getElementById("q");
    const fType = document.getElementById("fType");
    const onlyInStock = document.getElementById("onlyInStock");
    const clearBtn = document.getElementById("clearBtn");
    const results = document.getElementById("results");
    const empty = document.getElementById("empty");
    const stats = document.getElementById("stats");

    let arcas = {}; // {id: arcaObj}
    let flat  = []; // flattened items with arca info

    function norm(s){ return (s||"").toString().toLowerCase(); }
    function escapeHtml(s){ return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

    async function loadPins(){
      const pins = getPins();
      if (pins.length === 0){
        empty.classList.remove("hidden");
        results.innerHTML=""; stats.textContent="0 results";
        return;
      }
      empty.classList.add("hidden");
      // fetch all pinned arcas
      const snaps = await Promise.all(pins.map(id => db.ref("arca/"+id).once("value")));
      arcas = {};
      snaps.forEach(s => { if (s.exists()) arcas[s.key] = s.val(); });
      rebuildFlat();
      runSearch();
    }

    function rebuildFlat(){
      flat = [];
      Object.entries(arcas).forEach(([aid,a])=>{
        const items = a.items || {};
        Object.entries(items).forEach(([iid,it])=>{
          if (it && it.archived) return;
          const img = (it.images && it.images[0] && (it.images[0].dataUrl || it.images[0].url)) || "";
          flat.push({
            arcaId: aid,
            arcaName: a.name || aid,
            type: a.type || "",
            location: a.location || "",
            itemId: iid,
            itemName: it.name || "Unnamed",
            qty: Number(it.qty || 0),
            note: it.notes || "",
            img
          });
        });
      });
    }

    function runSearch(){
      const term = norm(q.value);
      const tFilter = fType.value;
      const stockOnly = !!onlyInStock.checked;
      const out = flat.filter(r=>{
        if (tFilter && r.type !== tFilter) return false;
        if (stockOnly && !(r.qty > 0)) return false;
        if (!term) return true;
        return [r.itemName, r.note, r.arcaName, r.location, r.type].some(s => norm(s).includes(term));
      });
      render(out);
    }

    function render(rows){
      stats.textContent = `${rows.length} result${rows.length===1?"":"s"}`;
      results.innerHTML = "";
      if (rows.length === 0){
        results.innerHTML = `<div class="glass rounded-2xl p-4 text-sm text-slate-300">No matches.</div>`;
        return;
      }
      // group by arca
      const grouped = {};
      rows.forEach(r => (grouped[r.arcaId] = grouped[r.arcaId] || []).push(r));

      Object.entries(grouped).forEach(([aid, list])=>{
        const a = arcas[aid] || {};
        const card = document.createElement("section");
        card.className = "glass rounded-2xl p-3";
        card.innerHTML = `
          <div class="flex items-center justify-between gap-3 mb-2">
            <div>
              <div class="text-base font-semibold">${escapeHtml(a.name || aid)}</div>
              <div class="text-xs text-slate-400"><span class="mr-2">${escapeHtml(a.type||"")}</span>${escapeHtml(a.location||"")}</div>
            </div>
            <div class="flex items-center gap-2">
              <a href="./display.html?arcaId=${encodeURIComponent(aid)}"
                 class="rounded-lg bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold px-3 py-2 text-sm">Open</a>
              <button data-unpin="${aid}" class="rounded-lg bg-slate-800 hover:bg-slate-700 px-3 py-2 text-sm">Unpin</button>
            </div>
          </div>
        `;
        const listEl = document.createElement("div");
        listEl.className = "grid md:grid-cols-2 lg:grid-cols-3 gap-2";
        list.forEach(it=>{
          const thumb = it.img
            ? `<img src="${it.img}" class="w-10 h-10 rounded-lg object-cover border border-slate-700"/>`
            : `<div class="w-10 h-10 rounded-lg bg-slate-800/70 border border-slate-700 flex items-center justify-center text-[10px] text-slate-500">No<br/>Photo</div>`;
          const row = document.createElement("div");
          row.className = "rounded-xl border border-slate-800 p-2 flex gap-2 items-center bg-slate-900/40";
          row.innerHTML = `
            ${thumb}
            <div class="min-w-0">
              <div class="text-sm font-medium truncate-1">${escapeHtml(it.itemName)}</div>
              <div class="text-[11px] text-slate-400 truncate-1">Qty ${it.qty} • ${escapeHtml(it.note||"")}</div>
            </div>
            <a href="./display.html?arcaId=${encodeURIComponent(aid)}" class="ml-auto text-xs text-emerald-300 hover:text-emerald-200">View</a>
          `;
          listEl.appendChild(row);
        });
        card.appendChild(listEl);
        results.appendChild(card);
      });

      // hook up Unpin buttons
      results.querySelectorAll("button[data-unpin]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-unpin");
          removePin(id);
          loadPins(); // refresh list
        });
      });
    }

    // events
    q.addEventListener("input", runSearch);
    fType.addEventListener("change", runSearch);
    onlyInStock.addEventListener("change", runSearch);
    clearBtn.addEventListener("click", ()=>{
      q.value=""; fType.value=""; onlyInStock.checked=false; runSearch();
    });

    // boot
    loadPins();
  </script>
</body>
</html>
