<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Arca • Migrate Images to Storage</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <main class="max-w-2xl mx-auto p-4 space-y-4">
    <h1 class="text-xl font-semibold">Migrate Embedded Images → Firebase Storage</h1>

    <div class="glass rounded-2xl p-4">
      <label class="text-xs block mb-1">Arca ID</label>
      <input id="arcaId" class="w-full rounded-xl px-3 py-2 bg-slate-800/60 outline-none" placeholder="e.g., ARCA-TAG1"/>
      <div class="mt-3 flex gap-2">
        <button id="scanBtn" class="rounded-xl px-3 py-2 bg-slate-800 hover:bg-slate-700">Scan</button>
        <button id="migrateBtn" class="rounded-xl px-3 py-2 bg-emerald-500 hover:bg-emerald-600 text-slate-900 font-semibold" disabled>Migrate</button>
      </div>
      <div id="log" class="mt-3 text-sm text-slate-300 whitespace-pre-wrap"></div>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <script>
    // Firebase
    const config = {
      apiKey: "AIzaSyAZoL7FPJ8wBqz_sX81Fo5eKXpsOVrLUZ0",
      authDomain: "tether-71e0c.firebaseapp.com",
      databaseURL: "https://tether-71e0c-default-rtdb.firebaseio.com",
      projectId: "tether-71e0c",
      storageBucket: "tether-71e0c.appspot.com"
    };
    firebase.initializeApp(config);
    const db = firebase.database();
    const storage = firebase.storage();
    const STORAGE_ROOT = "arca-images";

    const $ = s => document.querySelector(s);
    const logEl = $("#log");
    function log(msg){ logEl.textContent += msg + "\n"; }

    function dataURLToImage(dataUrl){
      return new Promise((res,rej)=>{
        const img = new Image();
        img.onload = ()=> res(img);
        img.onerror = rej;
        img.src = dataUrl;
      });
    }
    function canvasBlobFromImage(img, maxDim, quality=0.82, mime="image/jpeg"){
      const scale = Math.min(1, maxDim / Math.max(img.naturalWidth, img.naturalHeight));
      const w = Math.round(img.naturalWidth * scale), h = Math.round(img.naturalHeight * scale);
      const c = document.createElement("canvas"); c.width=w; c.height=h;
      c.getContext("2d").drawImage(img,0,0,w,h);
      return new Promise(res=> c.toBlob(res, mime, quality));
    }
    async function uploadBlob(path, blob){
      const ref = storage.ref().child(path);
      const snap = await ref.put(blob, { contentType: blob.type||"image/jpeg", cacheControl: "public,max-age=31536000" });
      return await snap.ref.getDownloadURL();
    }

    let toMigrate = { hero: null, items: [] };

    $("#scanBtn").addEventListener("click", async ()=>{
      const id = ($("#arcaId").value||"").trim();
      logEl.textContent = "";
      if (!id) return log("Enter an Arca ID.");
      log(`Scanning ${id} …`);
      const arcaSnap = await db.ref("arca/"+id).once("value");
      const arca = arcaSnap.val();
      if (!arca) { log("Arca not found."); return; }

      // Hero
      toMigrate = { hero: null, items: [] };
      if (arca.photo && arca.photo.dataUrl && !arca.photo.thumbUrl) {
        toMigrate.hero = { dataUrl: arca.photo.dataUrl, path: "photo" };
        log("• Hero photo: needs migration");
      }

      // Items
      const items = arca.items || {};
      let itemCount = 0, imageCount = 0;
      for (const [itemId, it] of Object.entries(items)){
        itemCount++;
        const imgs = Array.isArray(it.images) ? it.images : [];
        imgs.forEach((im, idx)=>{
          if (im && im.dataUrl && !im.thumbUrl) {
            toMigrate.items.push({ itemId, idx, dataUrl: im.dataUrl });
            imageCount++;
          }
        });
      }
      log(`• Items scanned: ${itemCount} — Images needing migration: ${imageCount}`);
      if (!toMigrate.hero && toMigrate.items.length===0) log("Nothing to migrate. ✅");
      $("#migrateBtn").disabled = (!toMigrate.hero && toMigrate.items.length===0);
    });

    $("#migrateBtn").addEventListener("click", async ()=>{
      const id = ($("#arcaId").value||"").trim();
      if (!id) return;
      $("#migrateBtn").disabled = true;

      try{
        // Hero first
        if (toMigrate.hero){
          log("Migrating hero…");
          const img = await dataURLToImage(toMigrate.hero.dataUrl);
          const fullBlob = await canvasBlobFromImage(img, 1200, 0.82);
          const thumbBlob = await canvasBlobFromImage(img, 360, 0.80);
          const now = Date.now();
          const base = `${STORAGE_ROOT}/${encodeURIComponent(id)}/arca-hero/${now}`;
          const [fullUrl, thumbUrl] = await Promise.all([
            uploadBlob(`${base}-full.jpg`, fullBlob),
            uploadBlob(`${base}-thumb.jpg`, thumbBlob)
          ]);
          await db.ref(`arca/${id}/photo`).set({ fullUrl, thumbUrl, takenAt: now });
          log("• Hero migrated.");
        }

        // Items
        let done = 0;
        for (const entry of toMigrate.items){
          const { itemId, idx, dataUrl } = entry;
          const img = await dataURLToImage(dataUrl);
          const fullBlob = await canvasBlobFromImage(img, 1200, 0.82);
          const thumbBlob = await canvasBlobFromImage(img, 360, 0.80);
          const now = Date.now();
          const base = `${STORAGE_ROOT}/${encodeURIComponent(id)}/${encodeURIComponent(itemId)}/${now}-${idx}`;
          const [fullUrl, thumbUrl] = await Promise.all([
            uploadBlob(`${base}-full.jpg`, fullBlob),
            uploadBlob(`${base}-thumb.jpg`, thumbBlob)
          ]);
          // Replace this image entry
          await db.ref(`arca/${id}/items/${itemId}/images/${idx}`).set({ fullUrl, thumbUrl, takenAt: now });
          done++;
          if (done % 5 === 0) log(`• Migrated ${done}/${toMigrate.items.length}…`);
        }
        log(`Done. Migrated ${toMigrate.items.length} item images. ✅`);
      }catch(e){
        console.error(e); log("Error: " + (e.message||e));
      }finally{
        $("#migrateBtn").disabled = false;
      }
    });
  </script>
</body>
</html>
